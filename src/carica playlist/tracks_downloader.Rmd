---
title: "R Notebook"
output: html_notebook
---

```{r}
# install.packages('pacman')
library(pacman)
pacman::p_load('spotifyr',  # To access the API
               'tidyverse', # Data wrangling and plots
               'plotly',    # Interactive plots
               'ggimage',   # Adding album covers to ggplot
               'kableExtra',# Format tables
               'httpuv',    # To be able to access the Spotify URL
               'httr')      # In case you want to access the API w/o
                            # the package
```

```{r}
library(spotifyr)
?spotifyr
```

# Get access
```{r}
CLIENT_ID='e862d6e00b244fe090bcb7bd0edd2fc8'
CLIENT_SECRET='d00ce12e600741ad8b614769eb52b7b8'

Sys.setenv(SPOTIFY_CLIENT_ID = CLIENT_ID)
Sys.setenv(SPOTIFY_CLIENT_SECRET = CLIENT_SECRET)

access_token <- get_spotify_access_token(
  client_id = Sys.getenv("SPOTIFY_CLIENT_ID"),
  client_secret = Sys.getenv("SPOTIFY_CLIENT_SECRET")
)
```


```{r}
# Store the data in a dataframe
EVERYTHING = "3EbHbn5D6oNFLJ5FrQKcAj?si=6ab30cd7e6794754"
ALTERNATIVE="39VgCTxGok4VIgIycgyTRq?si=f0ee9b71e9f048b2"
SHORT = "6zSzzHtzQxXVf9kuQXO3eS?si=7917643ebd854a5c"
AMICA_ALE = "0fCgMTSTRKPWUKp11pYQ6F?si=165f512ebe7b4a59"
ETTORE22 = "05oN1p78ynHAs0ulg4HvuF?si=069dd1d8a82b4d1e"

file_name = "ALTERNATIVE"


tracks <- get_playlist_audio_features(playlist_uris = ETTORE22)
head(tracks[,36])
dim(tracks)[1]
```


```{r}
features=c(
            "track.name" ,
            "track.album.name",
            "track.album.artists",
            "track.album.release_date",
            "track.duration_ms" ,
            "track.popularity",
            "acousticness", #
            "danceability", #
            "energy", #
            "instrumentalness", #
            "liveness", #
            "loudness", #
            "speechiness", #
            "tempo", #
            "key", ##
            "mode", ##
            "track.duration_ms" ,##
            "valence",##
            "time_signature", #
            "track.id"  # used to add the tracks to another playlists
)

data = tracks[features]
head(data)
```


```{r}
for(i in 1:dim(data)[1]){
  if(i%%500==0){
    Sys.sleep(50)
  }
  data[i,"artists"] = data[i,"track.album.artists"][[1]][[1]][3][1,]
  genres = get_artist(data[i,"track.album.artists"][[1]][[1]][[2]][1])$genres
  if(length(genres)!=0){
      for(j in 1:length(genres)){
         data[i,paste0("genre_",j)] = genres[j]
      }
  }
}


data$track.album.artists = NULL

# move the artists column at the beginning
library(dplyr )
data=data %>% relocate(artists, .after = track.name)
head(data)
```


```{r}
dim(data)
data[dim(data)[1],]
```



# Save data
```{r}

file_name = paste0(file_name,".csv")
write.csv(data, file =paste0("../data/",file_name), row.names = FALSE)
```





